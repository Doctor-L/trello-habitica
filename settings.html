<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="js/habitica_storage.js"></script>
  </head>
  <body>
    <h3>API</h3>
    
    <input id="user-id" type="text" placeholder="User ID">
    <input id="api-token" type="password" placeholder="API Token">

    <h3>Preferences</h3>

    <b>What cards to sync:</b>
    <select id="scope">
      <option value="none">All</option>
      <option value="me">Only assigned to me</option>
    </select>

    <b>Default difficulty for todos:</b>
    <select id="priority">
      <option value="0.5">Trivial</option>
      <option value="1">Easy</option>
      <option value="1.5">Medium</option>
      <option value="2">Hard</option>
    </select>

    <button id="submit-btn" type="submit" class="mod-primary">Save</button>
  
    <script>
      let t = TrelloPowerUp.iframe()
      let storage = new HabiticaStorage(t)
      let $submitButton = document.getElementById('submit-btn')

      let $userId   = document.getElementById('user-id')
      let $apiToken = document.getElementById('api-token')

      t.loadSecret('userId').then(val => $userId.value = val)
      t.loadSecret('apiToken').then(val => $apiToken.value = val)

      let $scope = document.getElementById('scope')
      let $priority = document.getElementById('priority')

      storage.getSettings().then(settings => {
        $scope.value = settings.scope
        $priority.value = settings.priority
      })

      $submitButton.addEventListener('click', () => {
        $submitButton.disabled = true
        
        return Promise.all([
          t.storeSecret('userId', $userId.value),
          t.storeSecret('apiToken', $apiToken.value),
          storage.setSettings({ 
            scope: $scope.value,
            priority: $priority.value
          })
        ]).then(() => {
          return t.closePopup()
        })
      })
    </script>
  </body>
</html>