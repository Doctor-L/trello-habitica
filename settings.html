<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
  </head>
  <body>
    <h3>
      API
    </h3>
    <input id="user-id" type="text" placeholder="User ID">
    <input id="api-token" type="password" placeholder="API Token">

    <h3>
      Preferences
    </h3>

    <b>What cards to sync:</b>
    <select id="scope">
      <option value="none">All</option>
      <option value="me">Only assigned to me</option>
    </select>

    <b>Default difficulty for todos:</b>
    <select id="difficulty">
      <option value="trivial">Trivial</option>
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>

    <button id="submit-btn" type="submit" class="mod-primary">Save</button>
  
    <script>
      let t = TrelloPowerUp.iframe()

      let $userId   = document.getElementById('user-id')
      let $apiToken = document.getElementById('api-token')

      t.loadSecret('userId').then(val => $userId.value = val)
      t.loadSecret('apiToken').then(val => $apiToken.value = val)

      let $scope = document.getElementById('scope')
      let $difficulty = document.getElementById('difficulty')

      t.get('member', 'private', 'settings', {
        scope: 'me',
        difficulty: 'easy'
      })
      .then(settings => {
        $scope.value = settings.scope
        $difficulty.value = settings.difficulty
      })

      document.getElementById('submit-btn').addEventListener('click', () => {
        Promise.all([
          t.storeSecret('userId', $userId.value),
          t.storeSecret('apiToken', $apiToken.value),
          t.set('member', 'private', 'settings', { 
            scope: $scope.value,
            difficulty: $difficulty.value
          })
        ]).then(() => {
          return t.closePopup()
        })
      })
    </script>
  </body>
</html>